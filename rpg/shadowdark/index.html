<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shadowdark Character Sheet (Unofficial)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root{
      --parchment-light: #fdf8ed;
      --parchment: #f4e4c1;
      --parchment-dark: #e8d4a8;
      --ink: #3d2817;
      --ink-light: #5c4033;
      --muted: #8b6f47;
      --border: #a68a64;
      --border-dark: #6b5638;
      --accent: #8b3a3a;
      --accent-light: #a0522d;
      --good: #3d6b3d;
      --warn: #b8860b;
      --bad: #8b2323;
      --shadow: 0 4px 12px rgba(61, 40, 23, 0.15);
      --shadow-heavy: 0 6px 20px rgba(61, 40, 23, 0.25);
      --r:4px;
      --mono: 'Courier New', Courier, monospace;
      --sans: 'Crimson Text', Georgia, serif;
      --display: 'Cinzel', serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      font-size:16px;
      background:
        /* Paper texture noise */
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(139,111,71,0.03) 2px, rgba(139,111,71,0.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139,111,71,0.03) 2px, rgba(139,111,71,0.03) 4px),
        /* Aging stains */
        radial-gradient(ellipse 800px 600px at 85% 15%, rgba(139,58,58,0.08), transparent 50%),
        radial-gradient(ellipse 600px 500px at 10% 80%, rgba(160,82,45,0.06), transparent 50%),
        /* Base parchment gradient */
        radial-gradient(ellipse at center, var(--parchment-light), var(--parchment-dark)),
        var(--parchment);
      color:var(--ink);
      position: relative;
    }
    /* Vignette effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      background: radial-gradient(ellipse at center, transparent 30%, rgba(61,40,23,0.15) 100%);
      z-index: 9999;
    }
    a{color:var(--accent);text-decoration-thickness:1px;text-decoration-color:var(--accent-light)}
    .wrap{max-width:1400px;margin:28px auto;padding:0 20px 50px;position:relative;z-index:1}
    header{
      display:flex;gap:18px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:26px;
      padding-bottom:20px;
      border-bottom:2px solid var(--border);
      position:relative;
    }
    /* Decorative header flourish */
    header::after {
      content: '‚öî';
      position:absolute;
      bottom:-12px;
      left:50%;
      transform:translateX(-50%);
      background:var(--parchment);
      padding:0 12px;
      color:var(--accent);
      font-size:16px;
    }
    .title h1{
      margin:0;
      font-family:var(--display);
      font-size:36px;
      letter-spacing:1px;
      color:var(--ink);
      font-weight:700;
      text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
    }
    .title p{margin:10px 0 0;color:var(--muted);font-size:16px;font-style:italic}
    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    }
    button, .btn{
      border:2px solid var(--border-dark);
      background:
        linear-gradient(135deg, var(--parchment-light) 0%, var(--parchment-dark) 100%);
      color:var(--ink);
      padding:12px 18px;
      border-radius:var(--r);
      cursor:pointer;
      font-size:15px;
      font-family:var(--display);
      font-weight:600;
      box-shadow:
        var(--shadow),
        inset 0 1px 0 rgba(255,255,255,0.4);
      display:inline-flex;gap:8px;align-items:center;
      transition:all 0.2s ease;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }
    button:hover{
      border-color:var(--accent);
      background:linear-gradient(135deg, var(--parchment) 0%, var(--parchment-dark) 100%);
      box-shadow:
        var(--shadow-heavy),
        inset 0 1px 0 rgba(255,255,255,0.4);
    }
    button:active{
      transform:translateY(1px);
      box-shadow:
        0 2px 6px rgba(61, 40, 23, 0.2),
        inset 0 1px 2px rgba(0,0,0,0.1);
    }
    button.primary{
      border-color:var(--accent);
      background:
        linear-gradient(135deg, rgba(139,58,58,0.15), rgba(139,58,58,0.05)),
        linear-gradient(135deg, var(--parchment-light) 0%, var(--parchment-dark) 100%);
      color:var(--accent);
    }
    button.danger{
      border-color:var(--bad);
      color:var(--bad);
    }
    .pill{
      font-family:var(--mono);
      font-size:13px;
      color:var(--muted);
      border:1px solid var(--border);
      background:rgba(232,212,168,0.3);
      padding:6px 12px;
      border-radius:999px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap:18px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:
        /* Paper texture */
        repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(139,111,71,0.02) 1px, rgba(139,111,71,0.02) 2px),
        linear-gradient(180deg, var(--parchment-light) 0%, #faf5e6 50%, var(--parchment-light) 100%);
      border:2px solid var(--border-dark);
      border-radius:var(--r);
      box-shadow:
        var(--shadow),
        inset 0 0 40px rgba(139,111,71,0.08);
      overflow:hidden;
      position:relative;
    }
    /* Decorative corners on cards */
    .card::before, .card::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-color: var(--accent);
      opacity: 0.3;
    }
    .card::before {
      top: 8px;
      left: 8px;
      border-top: 2px solid;
      border-left: 2px solid;
    }
    .card::after {
      top: 8px;
      right: 8px;
      border-top: 2px solid;
      border-right: 2px solid;
    }
    .card .hd{
      padding:18px 20px;
      border-bottom:2px double var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      background:
        linear-gradient(90deg,
          transparent 0%,
          rgba(139,58,58,0.06) 50%,
          transparent 100%),
        linear-gradient(180deg, rgba(253,248,237,0.8), rgba(244,228,193,0.3));
      position:relative;
    }
    .card .hd h2{
      margin:0;
      font-family:var(--display);
      font-size:20px;
      letter-spacing:2px;
      text-transform:uppercase;
      color:var(--accent);
      font-weight:700;
      text-shadow:1px 1px 0 rgba(255,255,255,0.8);
    }
    .card .hd .small{font-size:13px}
    .card .bd{padding:20px}

    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .field{display:flex;flex-direction:column;gap:8px}
    .field label{
      font-size:14px;
      color:var(--ink-light);
      letter-spacing:.5px;
      font-weight:600;
      text-transform:uppercase;
      font-family:var(--display);
    }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding:12px 14px;
      border-radius:var(--r);
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.5), rgba(232,212,168,0.2));
      color:var(--ink);
      outline:none;
      font-family:var(--sans);
      font-size:15px;
      box-shadow:
        inset 0 1px 3px rgba(61,40,23,0.1),
        0 1px 0 rgba(255,255,255,0.8);
      transition:all 0.2s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus{
      border-color:var(--accent);
      background:rgba(255,255,255,0.7);
      box-shadow:
        inset 0 1px 3px rgba(61,40,23,0.15),
        0 0 0 2px rgba(139,58,58,0.2);
    }
    input[type="number"]{font-family:var(--mono);font-weight:600}
    textarea{min-height:100px;resize:vertical;line-height:1.6}
    .small{font-size:14px;color:var(--muted);font-style:italic}
    .kpi{
      display:grid;grid-template-columns:repeat(4,1fr);gap:14px
    }
    @media (max-width:720px){ .kpi{grid-template-columns:repeat(2,1fr)} }

    .combatStat{
      border:3px solid var(--accent);
      background:
        linear-gradient(135deg, rgba(139,58,58,0.12), rgba(160,82,45,0.08)),
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border-radius:var(--r);
      padding:18px;
      box-shadow:
        var(--shadow),
        inset 0 0 20px rgba(139,58,58,0.08);
      position:relative;
      min-height:120px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .combatStat::before {
      content: '';
      position: absolute;
      top: 5px;
      left: 5px;
      right: 5px;
      bottom: 5px;
      border: 1px solid rgba(139,58,58,0.2);
      border-radius: 2px;
      pointer-events: none;
    }
    .combatStat label{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:1.5px;
      color:var(--accent);
      font-weight:700;
      font-family:var(--display);
      text-shadow:1px 1px 0 rgba(255,255,255,0.8);
    }
    .combatStat input{
      font-size:38px;
      font-weight:700;
      text-align:center;
      padding:24px 14px;
      background:rgba(255,255,255,0.6);
      border:2px solid var(--border);
      color:var(--accent);
      line-height:1.4;
      height:auto;
      min-height:100px;
      box-sizing:border-box;
      vertical-align:middle;
    }

    .damageBox{
      display:flex;
      gap:12px;
      align-items:center;
      padding:16px;
      border:2px solid var(--bad);
      background:
        linear-gradient(135deg, rgba(139,35,35,0.08), rgba(139,35,35,0.03)),
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border-radius:var(--r);
      margin-top:14px;
      box-shadow:
        var(--shadow),
        inset 0 0 15px rgba(139,35,35,0.08);
    }
    .damageBox label{
      font-family:var(--display);
      font-size:15px;
    }
    .damageBox input{
      width:100px;
      text-align:center;
      font-size:20px;
      font-weight:700;
      font-family:var(--mono);
      color:var(--bad);
      background:rgba(255,255,255,0.7);
    }
    .damageBox button{
      flex:1;
      justify-content:center;
    }

    .statusEffects{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-top:10px;
    }
    @media (max-width:720px){ .statusEffects{grid-template-columns:repeat(2,1fr)} }
    .statusCheck{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.4), rgba(232,212,168,0.2));
      border-radius:var(--r);
      cursor:pointer;
      transition:all .2s;
      box-shadow:inset 0 1px 2px rgba(61,40,23,0.08);
    }
    .statusCheck:hover{
      border-color:var(--warn);
      background:
        linear-gradient(135deg, rgba(184,134,11,0.15), rgba(184,134,11,0.05)),
        linear-gradient(180deg, rgba(255,255,255,0.5), rgba(232,212,168,0.3));
    }
    .statusCheck input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
      accent-color:var(--bad);
    }
    .statusCheck.active{
      border-color:var(--bad);
      background:
        linear-gradient(135deg, rgba(139,35,35,0.2), rgba(139,35,35,0.08)),
        linear-gradient(180deg, rgba(255,255,255,0.5), rgba(232,212,168,0.3));
      box-shadow:
        inset 0 1px 2px rgba(139,35,35,0.15),
        0 0 0 1px rgba(139,35,35,0.1);
    }

    .quickRef{
      margin-top:10px;
      border:2px solid var(--border);
      border-radius:var(--r);
      overflow:hidden;
      background:linear-gradient(180deg, var(--parchment-light), var(--parchment));
    }
    .quickRef .toggle{
      padding:12px 14px;
      background:
        linear-gradient(90deg, transparent, rgba(139,58,58,0.08) 50%, transparent),
        linear-gradient(180deg, rgba(253,248,237,0.6), rgba(232,212,168,0.3));
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      font-weight:600;
      font-family:var(--display);
      color:var(--accent);
      border-bottom:1px solid var(--border);
    }
    .quickRef .toggle:hover{
      background:
        linear-gradient(90deg, transparent, rgba(139,58,58,0.12) 50%, transparent),
        linear-gradient(180deg, rgba(253,248,237,0.8), rgba(232,212,168,0.4));
    }
    .quickRef .content{
      padding:14px;
      background:rgba(255,255,255,0.3);
      font-size:13px;
      line-height:1.7;
      display:none;
    }
    .quickRef .content.show{
      display:block;
    }
    .quickRef .content strong{
      color:var(--accent);
      font-family:var(--display);
    }
    .quickRef .content ul{
      margin:8px 0;
      padding-left:24px;
    }

    .diceRoller{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(70px, 1fr));
      gap:8px;
      margin-top:10px;
    }
    .diceBtn{
      padding:12px 8px;
      font-family:var(--mono);
      font-size:15px;
      font-weight:700;
      min-width:0;
      background:
        linear-gradient(135deg, rgba(139,58,58,0.1), transparent),
        linear-gradient(135deg, var(--parchment-light), var(--parchment-dark));
    }
    .rollResult{
      margin-top:12px;
      padding:12px 14px;
      border:2px solid var(--accent);
      background:
        linear-gradient(135deg, rgba(139,58,58,0.12), rgba(139,58,58,0.05)),
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border-radius:var(--r);
      text-align:center;
      font-family:var(--mono);
      font-size:20px;
      font-weight:700;
      color:var(--accent);
      display:none;
      box-shadow:var(--shadow);
      text-shadow:1px 1px 0 rgba(255,255,255,0.5);
    }
    .rollResult.show{
      display:block;
    }

    .presetModal{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(61,40,23,.92);
      backdrop-filter:blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    .presetModal.show{
      display:flex;
    }
    .presetBox{
      background:
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border:3px solid var(--border-dark);
      border-radius:var(--r);
      padding:28px;
      max-width:540px;
      width:90%;
      box-shadow:
        0 20px 60px rgba(0,0,0,.6),
        inset 0 0 40px rgba(139,111,71,0.1);
      position:relative;
    }
    /* Decorative corners for modal */
    .presetBox::before, .presetBox::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: var(--accent);
      opacity: 0.4;
    }
    .presetBox::before {
      top: 12px;
      left: 12px;
      border-top: 2px solid;
      border-left: 2px solid;
    }
    .presetBox::after {
      bottom: 12px;
      right: 12px;
      border-bottom: 2px solid;
      border-right: 2px solid;
    }
    .presetBox h3{
      margin:0 0 18px 0;
      font-size:22px;
      font-family:var(--display);
      color:var(--accent);
      text-align:center;
      letter-spacing:1px;
      text-shadow:1px 1px 0 rgba(255,255,255,0.7);
    }
    .presetList{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:18px;
    }
    .presetBtn{
      padding:16px;
      border:2px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.5), rgba(232,212,168,0.3));
      color:var(--ink);
      border-radius:var(--r);
      cursor:pointer;
      font-size:14px;
      text-align:left;
      transition:all .2s;
      box-shadow:inset 0 1px 2px rgba(61,40,23,0.08);
    }
    .presetBtn:hover{
      border-color:var(--accent);
      background:
        linear-gradient(135deg, rgba(139,58,58,0.08), transparent),
        linear-gradient(180deg, rgba(255,255,255,0.6), rgba(232,212,168,0.4));
      box-shadow:
        var(--shadow),
        inset 0 1px 2px rgba(61,40,23,0.08);
    }
    .presetBtn .name{
      font-weight:700;
      font-family:var(--display);
      margin-bottom:4px;
      color:var(--accent);
    }
    .presetBtn .desc{
      font-size:12px;
      color:var(--muted);
      font-style:italic;
    }

    .inventorySlots{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:8px;
    }
    .invSlot{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.4), rgba(232,212,168,0.2));
      border-radius:var(--r);
      box-shadow:inset 0 1px 2px rgba(61,40,23,0.06);
    }
    .invSlot .num{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      min-width:22px;
      font-weight:600;
    }
    .invSlot input{
      flex:1;
      padding:6px 8px;
      font-size:12px;
      min-width:0;
    }

    .spellTracker{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:300px;
      overflow-y:auto;
      padding:4px;
    }
    .spellItem{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.4), rgba(232,212,168,0.2));
      border-radius:var(--r);
      box-shadow:inset 0 1px 2px rgba(61,40,23,0.06);
      transition:all .2s;
    }
    .spellItem.lost{
      opacity:0.6;
      border-color:var(--bad);
      background:
        linear-gradient(135deg, rgba(139,35,35,0.1), rgba(139,35,35,0.05)),
        linear-gradient(180deg, rgba(255,255,255,0.4), rgba(232,212,168,0.2));
    }
    .spellItem input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
      accent-color:var(--bad);
      flex-shrink:0;
    }
    .spellItem .spellName{
      flex:1;
      font-size:14px;
      font-weight:600;
      color:var(--ink);
      font-family:var(--sans);
    }
    .spellItem.lost .spellName{
      text-decoration:line-through;
      color:var(--muted);
    }
    .spellItem .tierBadge{
      font-size:11px;
      font-weight:700;
      font-family:var(--display);
      padding:4px 8px;
      border-radius:999px;
      background:
        linear-gradient(135deg, rgba(139,58,58,0.15), rgba(139,58,58,0.08));
      color:var(--accent);
      border:1px solid var(--accent);
      letter-spacing:0.5px;
      flex-shrink:0;
    }
    .spellItem.lost .tierBadge{
      opacity:0.5;
    }

    .talentsList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .talentItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.4), rgba(232,212,168,0.2));
      border-radius:var(--r);
      box-shadow:inset 0 1px 2px rgba(61,40,23,0.06);
    }
    .talentItem .lvl{
      font-family:var(--display);
      font-size:11px;
      color:var(--ink-light);
      min-width:45px;
      font-weight:700;
      letter-spacing:0.5px;
    }
    .talentItem input{
      flex:1;
      padding:6px 8px;
      font-size:12px;
    }

    .deathTracker{
      display:flex;
      align-items:center;
      gap:14px;
      padding:16px;
      border:2px solid var(--bad);
      background:
        linear-gradient(135deg, rgba(139,35,35,0.15), rgba(139,35,35,0.05)),
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border-radius:var(--r);
      box-shadow:
        var(--shadow),
        inset 0 0 20px rgba(139,35,35,0.1);
    }
    .deathTracker .label{
      font-size:14px;
      font-weight:700;
      font-family:var(--display);
      color:var(--bad);
      letter-spacing:0.5px;
      text-shadow:1px 1px 0 rgba(255,255,255,0.5);
    }
    .deathTracker .deathSlots{
      display:flex;
      gap:8px;
    }
    .deathTracker input[type="checkbox"]{
      width:22px;
      height:22px;
      cursor:pointer;
      accent-color:var(--bad);
    }

    .statGrid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
    }
    .stat{
      border:2px solid var(--border-dark);
      background:
        linear-gradient(135deg, rgba(139,58,58,0.06), transparent),
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border-radius:var(--r);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      box-shadow:
        var(--shadow),
        inset 0 0 20px rgba(139,111,71,0.08);
      position:relative;
    }
    .stat::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      right: 3px;
      bottom: 3px;
      border: 1px solid rgba(139,58,58,0.15);
      border-radius: 2px;
      pointer-events: none;
    }
    .stat .name{
      font-weight:700;
      font-family:var(--display);
      letter-spacing:1.2px;
      font-size:14px;
      text-transform:uppercase;
      color:var(--accent);
      text-shadow:1px 1px 0 rgba(255,255,255,0.7);
    }
    .stat .modDisplay{
      font-family:var(--mono);
      font-size:48px;
      font-weight:700;
      line-height:1;
      text-align:center;
      min-width:90px;
      text-shadow:1px 1px 0 rgba(255,255,255,0.5);
    }
    .stat .scoreInput{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      color:var(--ink-light);
      font-family:var(--display);
    }
    .stat .scoreInput input{
      width:60px;
      padding:6px 8px;
      text-align:center;
      font-size:15px;
      border-radius:var(--r);
    }
    .stat .slotsInfo{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      font-style:italic;
    }
    .mod{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
    }
    .badge{
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.4), rgba(232,212,168,0.2));
      border-radius:var(--r);
      padding:12px 14px;
      display:flex;justify-content:space-between;gap:12px;
      font-family:var(--mono);
      font-size:14px;
      align-items:center;
      box-shadow:inset 0 1px 2px rgba(61,40,23,0.06);
    }
    .badge b{
      font-family:var(--display);
      font-size:13px;
      color:var(--ink-light);
      font-weight:700;
      letter-spacing:0.5px;
      text-transform:uppercase;
    }
    .badge .v{font-family:var(--mono);font-weight:600;font-size:15px}
    .good{color:var(--good)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .twoCol{
      display:grid;grid-template-columns:1fr 1fr;gap:14px
    }
    @media (max-width:720px){ .twoCol{grid-template-columns:1fr} }

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .list textarea{min-height:180px}
    .fine textarea{min-height:120px}

    .torchBox{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:start;
    }
    @media (max-width:720px){ .torchBox{grid-template-columns:1fr} }

    .timer{
      border:2px solid var(--border-dark);
      background:
        linear-gradient(135deg, rgba(160,82,45,0.08), transparent),
        linear-gradient(180deg, var(--parchment-light), var(--parchment));
      border-radius:var(--r);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:
        var(--shadow),
        inset 0 0 20px rgba(139,111,71,0.08);
    }
    .timer .clock{
      font-family:var(--mono);
      font-size:26px;
      font-weight:700;
      letter-spacing:1px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      color:var(--ink);
    }
    .timer .clock span{
      color:var(--muted);
      font-size:12px;
      font-style:italic;
      font-family:var(--sans);
    }
    .timer .controls{display:flex;gap:10px;flex-wrap:wrap}
    .timer .controls button{flex:1;justify-content:center;min-width:120px}
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      font-style:italic;
    }

    .footerNote{
      margin-top:16px;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      font-style:italic;
    }

    /* Print */
    @media print{
      body{background:var(--parchment);color:var(--ink)}
      body::before{display:none}
      .wrap{max-width:none;margin:0;padding:12px}
      header::after{display:none}
      header, .toolbar, .footerNote, .pill, .timer .controls, .hint, .damageBox, .diceRoller, .rollResult, .quickRef, .timer, .presetModal{display:none !important}
      .card{
        box-shadow:none;
        border-color:var(--border-dark);
        page-break-inside:avoid;
      }
      .card::before, .card::after{display:none}
      input, textarea, select{
        background:rgba(255,255,255,0.5);
        color:var(--ink);
        border-color:var(--border);
      }
      .card .hd{
        background:linear-gradient(180deg, rgba(253,248,237,0.6), rgba(244,228,193,0.3));
        border-bottom-color:var(--border);
      }
      .card .hd h2{color:var(--accent)}
      .badge{background:rgba(255,255,255,0.4);border-color:var(--border)}
      .combatStat{border-color:var(--accent);background:var(--parchment-light)}
      .combatStat::before{display:none}
      .combatStat label{color:var(--accent)}
      .combatStat input{background:rgba(255,255,255,0.6)}
      .statusCheck{border-color:var(--border);background:rgba(255,255,255,0.4)}
      .deathTracker{border-color:var(--bad);background:var(--parchment-light)}
      .stat{border-color:var(--border-dark);background:var(--parchment-light)}
      .stat::before{display:none}
      .stat .modDisplay{color:var(--ink)}
      .stat .name{color:var(--accent)}
      .invSlot{border-color:var(--border);background:rgba(255,255,255,0.4)}
      .spellItem{border-color:var(--border);background:rgba(255,255,255,0.4)}
      .talentItem{border-color:var(--border);background:rgba(255,255,255,0.4)}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Shadowdark Character Sheet <span class="pill">unofficial ‚Ä¢ single-file</span></h1>
        <p>Autosaves locally. Slot inventory, spell tracking, death timer, dice roller & 1-hour torches.</p>
      </div>
      <div class="toolbar">
        <button id="btnLoadPreset" title="Load a preset character">üìã Load Preset</button>
        <button class="primary" id="btnPrint" title="Print (or Save to PDF)">üñ®Ô∏è Print</button>
        <button id="btnExport" title="Export to JSON">‚¨áÔ∏è Export</button>
        <button id="btnImport" title="Import from JSON">‚¨ÜÔ∏è Import</button>
        <button class="danger" id="btnReset" title="Clear this sheet">üß® Reset</button>
      </div>
    </header>

    <!-- Preset Modal -->
    <div class="presetModal" id="presetModal">
      <div class="presetBox">
        <h3>Load Preset Character</h3>
        <div class="presetList" id="presetList">
          <!-- Preset buttons will be loaded dynamically -->
        </div>
        <button id="btnClosePreset" style="width:100%">Cancel</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <section class="card">
        <div class="hd">
          <h2>Identity</h2>
          <div class="small">Track the basics: name, ancestry, class, background, alignment, title.</div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field" style="grid-column: span 6;">
              <label for="name">Character Name</label>
              <input id="name" type="text" placeholder="e.g., Rone the Unlucky" />
            </div>
            <div class="field" style="grid-column: span 3;">
              <label for="ancestry">Ancestry</label>
              <input id="ancestry" type="text" placeholder="Human / Elf / Dwarf..." />
            </div>
            <div class="field" style="grid-column: span 3;">
              <label for="class">Class</label>
              <input id="class" type="text" placeholder="Fighter / Thief / Wizard / Priest..." />
            </div>

            <div class="field" style="grid-column: span 4;">
              <label for="background">Background</label>
              <input id="background" type="text" placeholder="Outcast / Scribe / Soldier..." />
            </div>
            <div class="field" style="grid-column: span 4;">
              <label for="alignment">Alignment</label>
              <select id="alignment">
                <option value=""></option>
                <option>Lawful</option>
                <option>Neutral</option>
                <option>Chaotic</option>
              </select>
            </div>
            <div class="field" style="grid-column: span 4;">
              <label for="title">Title</label>
              <input id="title" type="text" placeholder="e.g., Seeker / Robber..." />
            </div>

            <div class="field" style="grid-column: span 4;">
              <label for="deity">Deity (if Priest)</label>
              <input id="deity" type="text" placeholder="God of Light, etc." />
            </div>
            <div class="field" style="grid-column: span 8;">
              <label for="languages">Languages</label>
              <input id="languages" type="text" placeholder="Common, Elvish, ..." />
            </div>
            <div class="field" style="grid-column: span 12;">
              <label for="notes">Notes</label>
              <textarea id="notes" placeholder="Quick reminders / bonds / quirks" rows="3"></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT COLUMN -->
      <section class="card">
        <div class="hd">
          <h2>Vitals</h2>
          <div class="small">AC, HP, movement, luck, etc.</div>
        </div>
        <div class="bd">
          <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
            <div class="field combatStat">
              <label for="ac">AC</label>
              <input id="ac" type="number" step="1" />
            </div>
            <div class="field combatStat">
              <label for="hpCur">HP (Current)</label>
              <input id="hpCur" type="number" step="1" />
            </div>
            <div class="field combatStat">
              <label for="hpMax">HP (Max)</label>
              <input id="hpMax" type="number" step="1" />
            </div>
          </div>

          <div style="margin-top:14px">
            <div class="field">
              <label for="move">Move</label>
              <input id="move" type="number" step="5" placeholder="e.g., 30" />
            </div>
          </div>

          <div class="damageBox">
            <label for="dmgInput" style="font-size:13px;color:var(--bad);font-weight:600">Take Damage:</label>
            <input id="dmgInput" type="number" step="1" min="0" placeholder="0" />
            <button id="btnApplyDmg">‚öîÔ∏è Apply</button>
            <button id="btnHeal">üíö Heal</button>
          </div>

          <div style="height:10px"></div>

          <div class="twoCol">
            <div class="field">
              <label for="level">Level</label>
              <input id="level" type="number" step="1" />
            </div>
            <div class="field">
              <label for="xp">XP</label>
              <input id="xp" type="number" step="1" />
            </div>
            <div class="field">
              <label for="luck">Luck / Fortune</label>
              <input id="luck" type="text" placeholder="If your table uses it" />
            </div>
            <div class="field">
              <label for="coins">Coins</label>
              <input id="coins" type="text" placeholder="gp / sp / cp" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="deathTracker">
            <div class="label">Death Timer:</div>
            <div class="deathSlots">
              <label><input type="checkbox" id="death1" title="Round 1" /></label>
              <label><input type="checkbox" id="death2" title="Round 2" /></label>
              <label><input type="checkbox" id="death3" title="Round 3" /></label>
              <label><input type="checkbox" id="death4" title="Round 4" /></label>
              <label><input type="checkbox" id="death5" title="Round 5" /></label>
            </div>
            <div class="small" style="color:var(--bad)">Check one per round at 0 HP. Dead at 5 checks.</div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label>Status Effects</label>
            <div class="statusEffects">
              <label class="statusCheck">
                <input type="checkbox" id="status_prone" />
                <span>Prone</span>
              </label>
              <label class="statusCheck">
                <input type="checkbox" id="status_grappled" />
                <span>Grappled</span>
              </label>
              <label class="statusCheck">
                <input type="checkbox" id="status_poisoned" />
                <span>Poisoned</span>
              </label>
              <label class="statusCheck">
                <input type="checkbox" id="status_blinded" />
                <span>Blinded</span>
              </label>
              <label class="statusCheck">
                <input type="checkbox" id="status_deafened" />
                <span>Deafened</span>
              </label>
              <label class="statusCheck">
                <input type="checkbox" id="status_frightened" />
                <span>Frightened</span>
              </label>
            </div>
          </div>

          <div class="footerNote">
            Tip: you can keep this open on your phone. It autosaves to your browser.
          </div>
        </div>
      </section>

      <!-- LEFT: ABILITIES -->
      <section class="card">
        <div class="hd">
          <h2>Abilities</h2>
          <div class="small">Modifiers shown large. Enter scores (3‚Äì18) ‚Äî mods auto-calc.</div>
        </div>
        <div class="bd">
          <div class="statGrid" id="statGrid">
            <!-- stats injected by JS -->
          </div>

          <div style="height:12px"></div>

          <div class="mod">
            <div class="badge">
              <b>Attack Bonus (quick)</b>
              <span class="v" id="atkBonus">‚Äî</span>
            </div>
            <div class="badge">
              <b>Spellcasting Mod (quick)</b>
              <span class="v" id="spellMod">‚Äî</span>
            </div>
          </div>

          <div class="footerNote">
            Quick calc only (based on STR/DEX for attack, INT/WIS for spells depending on your class). Override in notes if your table differs.
          </div>
        </div>
      </section>

      <!-- RIGHT: SAVES / CHECKS -->
      <section class="card">
        <div class="hd">
          <h2>Checks & Saves</h2>
          <div class="small">Use as a quick reference (fill in your class bonuses if any).</div>
        </div>
        <div class="bd">
          <div class="twoCol">
            <div class="field">
              <label for="atk">Attack Bonus (final)</label>
              <input id="atk" type="text" placeholder="e.g., +2" />
            </div>
            <div class="field">
              <label for="spellAtk">Spell Attack / DC</label>
              <input id="spellAtk" type="text" placeholder="e.g., +3 / DC 12" />
            </div>
            <div class="field">
              <label for="save1">Save / Check Notes</label>
              <input id="save1" type="text" placeholder="e.g., Advantage vs poison" />
            </div>
            <div class="field">
              <label for="save2">Other</label>
              <input id="save2" type="text" placeholder="e.g., Turn undead +2" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label>Talents (by level)</label>
            <div class="talentsList">
              <div class="talentItem">
                <div class="lvl">Lvl 1:</div>
                <input id="talent1" type="text" placeholder="Ancestry or class talent..." />
              </div>
              <div class="talentItem">
                <div class="lvl">Lvl 2:</div>
                <input id="talent2" type="text" placeholder="Class talent..." />
              </div>
              <div class="talentItem">
                <div class="lvl">Lvl 4:</div>
                <input id="talent4" type="text" placeholder="Class talent..." />
              </div>
              <div class="talentItem">
                <div class="lvl">Lvl 7:</div>
                <input id="talent7" type="text" placeholder="Class talent..." />
              </div>
              <div class="talentItem">
                <div class="lvl">Lvl 10:</div>
                <input id="talent10" type="text" placeholder="Class talent..." />
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- LEFT: ATTACKS / SPELLS -->
      <section class="card">
        <div class="hd">
          <h2>Attacks & Spells</h2>
          <div class="small">Keep it lightweight: weapon lines + spell list.</div>
        </div>
        <div class="bd">
          <div class="twoCol">
            <div class="field">
              <label for="weapons">Weapons / Attacks</label>
              <textarea id="weapons" placeholder="Dagger +?, d4&#10;Shortsword +?, d6&#10;Bow +?, d6"></textarea>
            </div>
            <div class="field">
              <label>Known Spells / Miracles (track lost spells)</label>
              <div id="spellTracker" class="spellTracker">
                <!-- Spell items will be generated dynamically from spellsKnown -->
              </div>
              <button id="btnRestoreSpells" style="width:100%;margin-top:8px" title="Restore all lost spells after a rest">üåô Restore All Spells (Rest)</button>
              <div class="hint" style="margin-top:8px">
                Shadowdark spells: Roll d20 + casting mod + level vs DC (10 + tier). On failure, mark the spell as lost until rest.
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label for="spellsKnown">Edit Known Spells / Miracles</label>
            <textarea id="spellsKnown" placeholder="Format: Spell Name (T1), Another Spell (T2); Always Available Spell (always available)" style="min-height:100px"></textarea>
            <input id="spellsLost" type="hidden" value="" />
            <div class="hint">
              Format example: "Cure Wounds (T1), Shield of Faith (T1), Holy Weapon (T2); Turn Undead (always available)"
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: GEAR / INVENTORY + TORCH -->
      <section class="card">
        <div class="hd">
          <h2>Gear, Inventory & Light</h2>
          <div class="small">Gear, slots, and a simple torch timer.</div>
        </div>
        <div class="bd">
          <div class="field">
            <label>Inventory Slots (slots = STR score)</label>
            <div class="inventorySlots" id="inventorySlots">
              <!-- Generated by JS -->
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="timer">
            <div class="clock">
              <div>
                <div id="torchClock">60:00</div>
                <span id="torchState" class="small">Torch: ready</span>
              </div>
              <div class="badge" style="min-width:160px">
                <b>Torches</b>
                <span class="v"><input id="torches" type="number" step="1" min="0" style="width:72px;padding:6px 8px;border-radius:10px" /></span>
              </div>
            </div>

            <div class="controls">
              <button id="torchStart">üî• Start / Resume</button>
              <button id="torchPause">‚è∏Ô∏è Pause</button>
              <button id="torchNew">üïØÔ∏è New Torch (-1)</button>
            </div>

            <div class="hint">
              Default duration is 60:00. "New Torch" resets the timer to 60:00 and reduces your torch count by 1 (won't go below 0).
              This is just a table aid‚Äîuse whatever your group tracks.
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="twoCol">
            <div class="field">
              <label for="armor">Armor / Shield</label>
              <input id="armor" type="text" placeholder="Leather, Shield..." />
            </div>
            <div class="field">
              <label for="rations">Rations</label>
              <input id="rations" type="number" step="1" min="0" />
            </div>
          </div>
        </div>
      </section>

      <!-- FULL WIDTH: DICE ROLLER -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="hd">
          <h2>Dice Roller</h2>
          <div class="small">Quick rolls when you need them.</div>
        </div>
        <div class="bd">
          <div class="diceRoller">
            <button class="diceBtn" data-die="d20">d20</button>
            <button class="diceBtn" data-die="d12">d12</button>
            <button class="diceBtn" data-die="d10">d10</button>
            <button class="diceBtn" data-die="d8">d8</button>
            <button class="diceBtn" data-die="d6">d6</button>
            <button class="diceBtn" data-die="d4">d4</button>
          </div>
          <div id="rollResult" class="rollResult"></div>

          <div class="quickRef">
            <div class="toggle" id="quickRefToggle">
              <span>üìñ Quick Reference</span>
              <span>‚ñº</span>
            </div>
            <div class="content" id="quickRefContent">
              <strong>Common DCs:</strong>
              <ul>
                <li><strong>Easy:</strong> DC 9</li>
                <li><strong>Moderate:</strong> DC 12</li>
                <li><strong>Hard:</strong> DC 15</li>
                <li><strong>Extreme:</strong> DC 18</li>
              </ul>
              <strong>Advantage/Disadvantage:</strong> Roll 2d20, take higher (advantage) or lower (disadvantage).
              <br/><br/>
              <strong>Light Sources:</strong> Torch lasts 1 hour real-time (60 minutes). Lantern lasts 6 hours of use.
              <br/><br/>
              <strong>Common Actions:</strong> Move, Attack, Cast Spell, Dash (double move), Disengage, Hide, Help, Use Object.
            </div>
          </div>
        </div>
      </section>

      <!-- FULL WIDTH: STORY / CONDITIONS -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="hd">
          <h2>Conditions, Bonds, & Session Log</h2>
          <div class="small">Anything you don't want to forget mid-crawl.</div>
        </div>
        <div class="bd">
          <div class="twoCol">
            <div class="field">
              <label for="conditions">Conditions / Wounds</label>
              <textarea id="conditions" placeholder="Injured, exhausted, cursed, etc."></textarea>
            </div>
            <div class="field">
              <label for="log">Session Notes</label>
              <textarea id="log" placeholder="Treasure found, NPCs, hooks, damage taken..."></textarea>
            </div>
          </div>
        </div>
      </section>
    </div>

    <p class="footerNote">
      Unofficial Shadowdark fan tool with slot-based inventory, spell slot tracking, talent progression, death timer, and 1-hour torch duration.
      Perfect for one-shots and new players!
    </p>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // --------- Utilities ----------
    const $ = (id) => document.getElementById(id);

    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
    const toInt = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? Math.trunc(n) : 0;
    };
    const abilityMod = (score) => Math.floor((score - 10) / 2);
    const fmtMod = (m) => (m >= 0 ? `+${m}` : `${m}`);

    // --------- Build Stat UI ----------
    const STATS = [
      { key: "str", label: "STR" },
      { key: "dex", label: "DEX" },
      { key: "con", label: "CON" },
      { key: "int", label: "INT" },
      { key: "wis", label: "WIS" },
      { key: "cha", label: "CHA" },
    ];

    const statGrid = $("statGrid");
    for (const s of STATS) {
      const wrap = document.createElement("div");
      wrap.className = "stat";
      const slotsHint = s.key === "str" ? '<div class="slotsInfo" id="strSlots">Gear Slots: ‚Äî</div>' : '';
      wrap.innerHTML = `
        <div class="name">${s.label}</div>
        <div class="modDisplay" id="${s.key}Mod">+0</div>
        <div class="scoreInput">
          <span>Score:</span>
          <input id="${s.key}" type="number" step="1" min="1" max="30" placeholder="10" />
        </div>
        ${slotsHint}
      `;
      statGrid.appendChild(wrap);
    }

    // --------- Build Inventory Slots ----------
    const invGrid = $("inventorySlots");
    const MAX_INV_SLOTS = 20; // Support up to 20 STR
    for (let i = 1; i <= MAX_INV_SLOTS; i++) {
      const slot = document.createElement("div");
      slot.className = "invSlot";
      slot.id = `invSlot${i}`;
      slot.innerHTML = `
        <div class="num">${i}.</div>
        <input id="inv${i}" type="text" placeholder="Item..." />
      `;
      invGrid.appendChild(slot);
    }

    // --------- Autosave ----------
    const STORAGE_KEY = "shadowdark_sheet_v1";

    const allFields = () => {
      // Grab inputs/textarea/select plus stat fields we injected
      const nodes = document.querySelectorAll("input, textarea, select");
      return Array.from(nodes).filter(n => n.id && n.type !== "file");
    };

    function serialize() {
      const data = {};
      for (const el of allFields()) {
        if (el.type === "number") {
          data[el.id] = el.value === "" ? "" : toInt(el.value);
        } else {
          data[el.id] = el.value ?? "";
        }
      }
      // Torch timer persisted separately
      data.__torch = {
        remainingMs: torch.remainingMs,
        running: torch.running,
        lastTick: torch.lastTick,
        durationMs: torch.durationMs
      };
      return data;
    }

    function apply(data) {
      for (const el of allFields()) {
        if (!(el.id in data)) continue;
        const v = data[el.id];
        el.value = (v === null || v === undefined) ? "" : String(v);
      }
      if (data.__torch) {
        torch.durationMs = data.__torch.durationMs ?? torch.durationMs;
        torch.remainingMs = data.__torch.remainingMs ?? torch.durationMs;
        torch.running = !!data.__torch.running;
        torch.lastTick = data.__torch.lastTick ?? 0;
      }
      recalcAll();
      renderTorch();
      renderSpellTracker(); // Render spells after loading data
      if (torch.running) startTorchLoop(); // resume if it was running
    }

    function save() {
      const data = serialize();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        apply(JSON.parse(raw));
      } catch {
        // ignore corrupted storage
      }
    }

    // --------- Calculations ----------
    function recalcStats() {
      for (const s of STATS) {
        const score = toInt($(s.key).value || 10);
        const mod = abilityMod(score);
        const modEl = $(s.key + "Mod");
        modEl.textContent = fmtMod(mod);
        modEl.classList.remove("good","warn","bad");
        if (mod >= 2) modEl.classList.add("good");
        else if (mod <= -1) modEl.classList.add("bad");
        else modEl.classList.add("warn");
      }

      // Update STR slots display and inventory visibility
      const strScore = toInt($("str").value || 10);
      const slotsEl = $("strSlots");
      if (slotsEl) {
        slotsEl.textContent = `Gear Slots: ${strScore}`;
      }

      // Show/hide inventory slots based on STR
      for (let i = 1; i <= 20; i++) {
        const slotEl = $(`invSlot${i}`);
        if (slotEl) {
          slotEl.style.display = i <= strScore ? '' : 'none';
        }
      }
    }

    function recalcQuickBonuses() {
      // Quick estimate:
      // Attack: best of STR/DEX mod
      // Spell: best of INT/WIS mod (pick one depending on class; this is a quick helper)
      const strM = abilityMod(toInt($("str").value || 10));
      const dexM = abilityMod(toInt($("dex").value || 10));
      const intM = abilityMod(toInt($("int").value || 10));
      const wisM = abilityMod(toInt($("wis").value || 10));

      const atk = Math.max(strM, dexM);
      const spl = Math.max(intM, wisM);

      $("atkBonus").textContent = fmtMod(atk);
      $("spellMod").textContent = fmtMod(spl);
    }

    function recalcAll() {
      recalcStats();
      recalcQuickBonuses();
      save();
    }

    // --------- Spell Tracker ----------
    function parseSpells(spellsKnownText) {
      // Parse "Spell Name (T1), Another Spell (T2); Special (always available)"
      // Returns array of {name, tier, alwaysAvailable}
      if (!spellsKnownText || spellsKnownText.trim() === "") return [];

      const spells = [];
      const parts = spellsKnownText.split(/[,;]/).map(s => s.trim()).filter(s => s);

      for (const part of parts) {
        // Match "Spell Name (T#)" or "Spell Name (Tier #)" or variations
        const match = part.match(/^(.+?)\s*\((?:T(?:ier\s*)?)?(\d+|always available)\)/i);
        if (match) {
          const name = match[1].trim();
          const tierText = match[2].toLowerCase();
          const alwaysAvailable = tierText === 'always available';
          const tier = alwaysAvailable ? 0 : parseInt(tierText) || 0;
          spells.push({ name, tier, alwaysAvailable });
        } else if (part.trim()) {
          // If no tier found, just add the spell with tier 0
          spells.push({ name: part.trim(), tier: 0, alwaysAvailable: false });
        }
      }

      return spells;
    }

    function renderSpellTracker() {
      const spellsKnown = $("spellsKnown")?.value || "";
      const spellsLostField = $("spellsLost");
      const spellsLost = spellsLostField ? spellsLostField.value.split(',').map(s => s.trim()).filter(s => s) : [];

      const spells = parseSpells(spellsKnown);
      const container = $("spellTracker");

      if (!container) return;

      container.innerHTML = "";

      if (spells.length === 0) {
        container.innerHTML = '<div style="padding:12px;text-align:center;color:var(--muted);font-style:italic;font-size:13px">No spells entered yet. Add spells in the textarea below.</div>';
        return;
      }

      spells.forEach(spell => {
        const isLost = spellsLost.includes(spell.name);
        const item = document.createElement("div");
        item.className = "spellItem" + (isLost ? " lost" : "");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = isLost;
        checkbox.disabled = spell.alwaysAvailable; // Can't lose always-available spells
        checkbox.title = spell.alwaysAvailable ? "Always available" : "Check if spell is lost";
        checkbox.addEventListener("change", () => {
          toggleSpellLost(spell.name);
        });

        const nameSpan = document.createElement("span");
        nameSpan.className = "spellName";
        nameSpan.textContent = spell.name;

        const badge = document.createElement("span");
        badge.className = "tierBadge";
        badge.textContent = spell.alwaysAvailable ? "Always" : `T${spell.tier}`;

        item.appendChild(checkbox);
        item.appendChild(nameSpan);
        item.appendChild(badge);
        container.appendChild(item);
      });
    }

    function toggleSpellLost(spellName) {
      const spellsLostField = $("spellsLost");
      if (!spellsLostField) return;

      let lostSpells = spellsLostField.value.split(',').map(s => s.trim()).filter(s => s);

      if (lostSpells.includes(spellName)) {
        // Remove from lost
        lostSpells = lostSpells.filter(s => s !== spellName);
      } else {
        // Add to lost
        lostSpells.push(spellName);
      }

      spellsLostField.value = lostSpells.join(', ');
      renderSpellTracker();
      save();
    }

    function restoreAllSpells() {
      const spellsLostField = $("spellsLost");
      if (spellsLostField) {
        spellsLostField.value = "";
        renderSpellTracker();
        save();
      }
    }

    // --------- Torch Timer ----------
    const torch = {
      durationMs: 60 * 60 * 1000, // 1 hour
      remainingMs: 60 * 60 * 1000,
      running: false,
      intervalId: null,
      lastTick: 0
    };

    function msToClock(ms) {
      ms = Math.max(0, ms);
      const totalSec = Math.ceil(ms / 1000);
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function torchStateText() {
      if (!torch.running && torch.remainingMs === torch.durationMs) return "Torch: ready";
      if (!torch.running && torch.remainingMs > 0) return "Torch: paused";
      if (torch.running && torch.remainingMs > 0) return "Torch: burning";
      return "Torch: out";
    }

    function renderTorch() {
      $("torchClock").textContent = msToClock(torch.remainingMs);
      const st = $("torchState");
      st.textContent = torchStateText();

      st.classList.remove("good","warn","bad");
      if (torch.remainingMs <= 0) st.classList.add("bad");
      else if (torch.remainingMs <= 5 * 60 * 1000) st.classList.add("warn");
      else st.classList.add("good");
    }

    function stopTorchLoop() {
      if (torch.intervalId) {
        clearInterval(torch.intervalId);
        torch.intervalId = null;
      }
    }

    function startTorchLoop() {
      stopTorchLoop();
      torch.running = true;
      torch.lastTick = Date.now();
      torch.intervalId = setInterval(() => {
        const now = Date.now();
        const dt = now - torch.lastTick;
        torch.lastTick = now;

        torch.remainingMs -= dt;
        if (torch.remainingMs <= 0) {
          torch.remainingMs = 0;
          torch.running = false;
          stopTorchLoop();
        }
        renderTorch();
        save();
      }, 250);
      renderTorch();
      save();
    }

    function pauseTorch() {
      torch.running = false;
      stopTorchLoop();
      renderTorch();
      save();
    }

    function newTorch() {
      const t = $("torches");
      const cur = clamp(toInt(t.value || 0), 0, 9999);
      if (cur > 0) t.value = String(cur - 1);
      torch.remainingMs = torch.durationMs;
      torch.running = true;
      startTorchLoop();
      recalcAll(); // will save too
    }

    // --------- Export / Import ----------
    function exportJSON() {
      const data = serialize();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (data.name ? `${data.name}` : "shadowdark-character") + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 3000);
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(String(reader.result || "{}"));
          apply(data);
          save();
        } catch {
          alert("That file doesn't look like valid JSON for this sheet.");
        }
      };
      reader.readAsText(file);
    }

    // --------- Damage / Heal ----------
    function applyDamage() {
      const dmg = toInt($("dmgInput").value || 0);
      if (dmg <= 0) return;
      const cur = toInt($("hpCur").value || 0);
      $("hpCur").value = String(Math.max(0, cur - dmg));
      $("dmgInput").value = "";
      recalcAll();
    }

    function healDamage() {
      const heal = toInt($("dmgInput").value || 0);
      if (heal <= 0) return;
      const cur = toInt($("hpCur").value || 0);
      const max = toInt($("hpMax").value || 0);
      $("hpCur").value = String(Math.min(max, cur + heal));
      $("dmgInput").value = "";
      recalcAll();
    }

    // --------- Status Effects ----------
    function updateStatusStyles() {
      const checkboxes = document.querySelectorAll('.statusCheck input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const label = cb.closest('.statusCheck');
        if (cb.checked) {
          label.classList.add('active');
        } else {
          label.classList.remove('active');
        }
      });
    }

    // --------- Dice Roller ----------
    function rollDie(sides) {
      return Math.floor(Math.random() * sides) + 1;
    }

    function showRoll(die, result) {
      const resultEl = $("rollResult");
      resultEl.textContent = `${die}: ${result}`;
      resultEl.classList.add("show");
      setTimeout(() => {
        resultEl.classList.remove("show");
      }, 3000);
    }

    // --------- Quick Reference Toggle ----------
    function toggleQuickRef() {
      const content = $("quickRefContent");
      const toggle = $("quickRefToggle");
      const arrow = toggle.querySelector("span:last-child");

      if (content.classList.contains("show")) {
        content.classList.remove("show");
        arrow.textContent = "‚ñº";
      } else {
        content.classList.add("show");
        arrow.textContent = "‚ñ≤";
      }
    }

    // --------- Preset Loading ----------
    async function loadPresetsManifest() {
      try {
        const response = await fetch('presets.json');
        if (!response.ok) {
          throw new Error('presets.json not found');
        }
        const presets = await response.json();
        const container = $("presetList");
        container.innerHTML = ''; // Clear existing buttons

        presets.forEach(preset => {
          const btn = document.createElement('button');
          btn.className = 'presetBtn';
          btn.dataset.preset = preset.file;
          btn.innerHTML = `
            <div class="name">${preset.name}</div>
            <div class="desc">${preset.description}</div>
          `;
          btn.addEventListener("click", () => loadPreset(preset.file));
          container.appendChild(btn);
        });
      } catch (error) {
        const container = $("presetList");
        container.innerHTML = '<p style="color:var(--ink);text-align:center;">No presets available. Create a presets.json file to add presets.</p>';
      }
    }

    function openPresetModal() {
      $("presetModal").classList.add("show");
      loadPresetsManifest(); // Load presets when modal opens
    }

    function closePresetModal() {
      $("presetModal").classList.remove("show");
    }

    async function loadPreset(filename) {
      try {
        const response = await fetch(filename);
        if (!response.ok) {
          throw new Error(`Failed to load preset: ${response.statusText}`);
        }
        const data = await response.json();
        apply(data);
        save();
        closePresetModal();
        alert(`Preset loaded successfully! Character: ${data.name || 'Unknown'}`);
      } catch (error) {
        alert(`Error loading preset: ${error.message}\n\nMake sure the file "${filename}" exists in the same folder as this HTML file.`);
      }
    }

    // --------- Wire Up Events ----------
    function wire() {
      // Recalc & save on input
      for (const el of allFields()) {
        el.addEventListener("input", () => {
          // keep torch count sane
          if (el.id === "torches") el.value = String(clamp(toInt(el.value || 0), 0, 9999));
          recalcAll();
        });
      }

      // Damage/Heal buttons
      $("btnApplyDmg").addEventListener("click", applyDamage);
      $("btnHeal").addEventListener("click", healDamage);
      $("dmgInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") applyDamage();
      });

      // Status effect checkboxes
      document.querySelectorAll('.statusCheck input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", () => {
          updateStatusStyles();
          save();
        });
      });

      // Dice roller
      document.querySelectorAll('.diceBtn').forEach(btn => {
        btn.addEventListener("click", () => {
          const die = btn.dataset.die;
          const sides = parseInt(die.substring(1));
          const result = rollDie(sides);
          showRoll(die, result);
        });
      });

      // Quick reference toggle
      $("quickRefToggle").addEventListener("click", toggleQuickRef);

      // Spell tracker
      $("spellsKnown").addEventListener("input", () => {
        renderSpellTracker();
        save();
      });
      $("btnRestoreSpells").addEventListener("click", restoreAllSpells);

      // Preset modal
      $("btnLoadPreset").addEventListener("click", openPresetModal);
      $("btnClosePreset").addEventListener("click", closePresetModal);
      $("presetModal").addEventListener("click", (e) => {
        if (e.target === $("presetModal")) closePresetModal();
      });

      // Preset buttons are now added dynamically in loadPresetsManifest()

      $("btnPrint").addEventListener("click", () => window.print());

      $("btnExport").addEventListener("click", exportJSON);

      $("btnImport").addEventListener("click", () => $("fileInput").click());
      $("fileInput").addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) importJSON(f);
        e.target.value = "";
      });

      $("btnReset").addEventListener("click", () => {
        if (!confirm("Reset this character sheet? This clears local autosave for this sheet.")) return;
        localStorage.removeItem(STORAGE_KEY);
        stopTorchLoop();
        // clear fields
        for (const el of allFields()) el.value = "";
        // reset torch
        torch.durationMs = 60 * 60 * 1000;
        torch.remainingMs = torch.durationMs;
        torch.running = false;
        renderTorch();
        recalcAll();
      });

      $("torchStart").addEventListener("click", () => {
        if (torch.remainingMs <= 0) torch.remainingMs = torch.durationMs;
        startTorchLoop();
      });
      $("torchPause").addEventListener("click", pauseTorch);
      $("torchNew").addEventListener("click", newTorch);

      // sensible defaults
      if ($("torches").value === "") $("torches").value = "6";
      if ($("rations").value === "") $("rations").value = "0";
      renderTorch();
      updateStatusStyles();
    }

    // Init
    wire();
    load();
    recalcAll();
    renderTorch();
    renderSpellTracker();
    updateStatusStyles();
  </script>
</body>
</html>
